generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           Int       @id @default(autoincrement())
  email        String    @unique
  name         String
  role         String    @default("employee")
  passwordHash String
  active       Boolean   @default(true)
  createdAt    DateTime  @default(now())
  sessions     Session[]
  balance      PtoBalance?
  timeRequests TimeRequest[]
  approvedRequests TimeRequest[] @relation("TimeRequestApprover")
  accrualRule  AccrualRule?
  refreshTokens RefreshToken[]
  authLogs     AuthAuditLog[]
  timesheetEditRequests TimesheetEditRequest[]
  reviewedTimesheetEdits TimesheetEditRequest[] @relation("TimesheetEditReviewer")
  balanceLedgerEntries BalanceLedger[] @relation("BalanceLedgerUser")
  createdBalanceLedgerEntries BalanceLedger[] @relation("BalanceLedgerCreatedBy")
  payrollConfigs EmployeeCompConfig[]
  submittedEmployeeConfigs EmployeeCompConfig[] @relation("EmployeeConfigSubmittedBy")
  attendanceFacts AttendanceMonthFact[]
  bonusCandidates BonusCandidate[] @relation("BonusCandidateUser")
  approvedBonusCandidates BonusCandidate[] @relation("BonusCandidateApprovedBy")
  payrollLines PayrollLine[]
  approvedPayrollPeriods PayrollPeriod[] @relation("PayrollApprovedBy")
  paidPayrollPeriods PayrollPeriod[] @relation("PayrollPaidBy")
  createdHolidays Holiday[] @relation("HolidayCreatedBy")
  createdAuditLogs PayrollAuditLog[] @relation("PayrollAuditCreatedBy")
  shiftAssignments ShiftAssignment[]
}

model Session {
  id                 String            @id @default(cuid())
  userId             Int
  user               User              @relation(fields: [userId], references: [id])
  deviceId           String
  startedAt          DateTime          @default(now())
  endedAt            DateTime?
  status             String            @default("active")
  presencePlanCount  Int               @default(0)
  presenceChecks     PresencePrompt[]
  events             Event[]
  minuteStats        MinuteStat[]
  pauses             SessionPause[]
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
}

model Event {
  id        String     @id @default(cuid())
  sessionId String
  session   Session    @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  ts        DateTime   @default(now())
  type      String
  payload   String
}

model MinuteStat {
  id          Int       @id @default(autoincrement())
  sessionId   String
  session     Session   @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  minuteStart DateTime
  active      Boolean
  idle        Boolean
  keysCount   Int
  mouseCount  Int
  fgApp       String?
  createdAt   DateTime  @default(now())

  @@unique([sessionId, minuteStart])
}

model PresencePrompt {
  id          String          @id @default(cuid())
  sessionId   String
  session     Session         @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  scheduledAt DateTime
  triggeredAt DateTime?
  expiresAt   DateTime?
  respondedAt DateTime?
  status      String          @default("scheduled")
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
}

model TimeRequest {
  id            String    @id @default(cuid())
  userId        Int
  user          User      @relation(fields: [userId], references: [id])
  type          String
  status        String    @default("pending")
  startDate     DateTime
  endDate       DateTime
  hours         Float
  reason        String?
  approverId    Int?
  approver      User?     @relation("TimeRequestApprover", fields: [approverId], references: [id])
  approvedAt    DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

model EmployeeCompConfig {
  id                       Int       @id @default(autoincrement())
  userId                   Int
  user                     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  effectiveOn              DateTime
  baseSemiMonthlySalary    Decimal   @db.Decimal(12, 2)
  monthlyAttendanceBonus   Decimal   @db.Decimal(12, 2)
  quarterlyAttendanceBonus Decimal   @db.Decimal(12, 2)
  kpiEligible              Boolean   @default(false)
  defaultKpiBonus          Decimal?  @db.Decimal(12, 2)
  schedule                 Json
  accrualEnabled           Boolean   @default(false)
  accrualMethod            String?
  ptoBalanceHours          Decimal   @default(0) @db.Decimal(10, 2)
  utoBalanceHours          Decimal   @default(0) @db.Decimal(10, 2)
  submittedById            Int?
  submittedBy              User?     @relation("EmployeeConfigSubmittedBy", fields: [submittedById], references: [id], onDelete: SetNull)
  submittedAt              DateTime  @default(now())
  createdAt                DateTime  @default(now())
  updatedAt                DateTime  @updatedAt

  @@unique([userId, effectiveOn])
  @@index([effectiveOn])
}

model Holiday {
  id          Int      @id @default(autoincrement())
  name        String
  observedOn  DateTime
  createdById Int?
  createdBy   User?    @relation("HolidayCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([observedOn])
  @@index([observedOn])
}

model AttendanceMonthFact {
  id                     Int      @id @default(autoincrement())
  userId                 Int
  user                   User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  monthKey               String
  rangeStart             DateTime
  rangeEnd               DateTime
  assignedHours          Decimal  @db.Decimal(10, 2)
  workedHours            Decimal  @db.Decimal(10, 2)
  ptoHours               Decimal  @db.Decimal(10, 2)
  utoAbsenceHours     Decimal  @default(0) @db.Decimal(10, 2)
  tardyMinutes           Int
  matchedMakeUpHours     Decimal  @db.Decimal(10, 2)
  isPerfect              Boolean
  reasons                Json
  snapshot               Json
  computedAt             DateTime @default(now())

  @@unique([userId, monthKey])
  @@index([monthKey])
}

model BonusCandidate {
  id              Int      @id @default(autoincrement())
  userId          Int
  user            User     @relation("BonusCandidateUser", fields: [userId], references: [id], onDelete: Cascade)
  type            String
  periodKey       String
  eligiblePayDate DateTime
  amount          Decimal   @db.Decimal(12, 2)
  status          String    @default("pending")
  finalAmount     Decimal?  @db.Decimal(12, 2)
  notes           String?
  snapshot        Json
  computedAt      DateTime  @default(now())
  approvedAt      DateTime?
  approvedById    Int?
  approvedBy      User?     @relation("BonusCandidateApprovedBy", fields: [approvedById], references: [id], onDelete: SetNull)

  @@unique([userId, type, periodKey])
  @@index([eligiblePayDate])
  @@index([type])
}

model PayrollPeriod {
  id           Int          @id @default(autoincrement())
  periodKey    String       @unique
  periodStart  DateTime
  periodEnd    DateTime
  payDate      DateTime
  status       String       @default("draft")
  totals       Json
  computedAt   DateTime     @default(now())
  approvedAt   DateTime?
  approvedById Int?
  approvedBy   User?        @relation("PayrollApprovedBy", fields: [approvedById], references: [id], onDelete: SetNull)
  paidAt       DateTime?
  paidById     Int?
  paidBy       User?        @relation("PayrollPaidBy", fields: [paidById], references: [id], onDelete: SetNull)
  lines        PayrollLine[]

  @@index([payDate])
}

model PayrollLine {
  id                    Int      @id @default(autoincrement())
  payrollPeriodId       Int
  payrollPeriod         PayrollPeriod @relation(fields: [payrollPeriodId], references: [id], onDelete: Cascade)
  userId                Int
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  baseAmount            Decimal  @db.Decimal(12, 2)
  monthlyAttendance     Decimal  @db.Decimal(12, 2)
  monthlyDeferred       Decimal  @db.Decimal(12, 2)
  quarterlyAttendance   Decimal  @db.Decimal(12, 2)
  kpiBonus              Decimal  @db.Decimal(12, 2)
  finalAmount           Decimal  @db.Decimal(12, 2)
  snapshot              Json
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@unique([payrollPeriodId, userId])
}

model PayrollAuditLog {
  id          Int      @id @default(autoincrement())
  actorId     Int?
  actor       User?    @relation("PayrollAuditCreatedBy", fields: [actorId], references: [id], onDelete: SetNull)
  scope       String
  target      String
  action      String
  details     Json
  createdAt   DateTime @default(now())

  @@index([scope])
  @@index([action])
  @@index([createdAt])
}

model PtoBalance {
  id           Int      @id @default(autoincrement())
  userId       Int      @unique
  user         User     @relation(fields: [userId], references: [id])
  basePtoHours     Float    @default(0)
  baseUtoHours     Float    @default(0)
  baseMakeUpHours  Float    @default(0)
  ptoHours         Float    @default(0)
  utoHours         Float    @default(0)
  makeUpHours      Float    @default(0)
  lastAccrualMonth String?
  updatedAt    DateTime @updatedAt
  createdAt    DateTime @default(now())
}

model BalanceLedger {
  id          Int      @id @default(autoincrement())
  userId      Int
  user        User     @relation("BalanceLedgerUser", fields: [userId], references: [id], onDelete: Cascade)
  type        String   @default("pto")
  deltaHours  Float
  reason      String?
  createdById Int?
  createdBy   User?    @relation("BalanceLedgerCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)
  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([createdAt])
}

model AccrualRule {
  id            Int      @id @default(autoincrement())
  userId        Int?     @unique
  user          User?    @relation(fields: [userId], references: [id])
  isDefault     Boolean  @default(false)
  hoursPerMonth Float    @default(0)
  ptoHoursPerMonth     Float    @default(0)
  utoHoursPerMonth     Float    @default(0)
  makeUpHoursPerMonth  Float    @default(0)
  startDate     DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model RefreshToken {
  id               String   @id @default(cuid())
  userId           Int
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  tokenHash        String   @unique
  scope            String
  deviceId         String?
  ipAddress        String?
  userAgent        String?
  expiresAt        DateTime
  createdAt        DateTime @default(now())
  revokedAt        DateTime?
  revokedReason    String?
  replacedByTokenId String?

  @@index([userId])
}

model AuthAuditLog {
  id        String   @id @default(cuid())
  email     String
  userId    Int?
  user      User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  event     String
  success   Boolean
  reason    String?
  ipAddress String?
  userAgent String?
  deviceId  String?
  createdAt DateTime @default(now())

  @@index([email])
  @@index([createdAt])
}

model Config {
  key       String   @id
  value     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model TimesheetEditRequest {
  id              String   @id @default(cuid())
  userId          Int
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  view            String
  periodStart     DateTime
  periodEnd       DateTime
  targetDate      DateTime
  requestedMinutes Int?
  reason          String
  status          String   @default("pending")
  reviewerId      Int?
  reviewer        User?    @relation("TimesheetEditReviewer", fields: [reviewerId], references: [id], onDelete: SetNull)
  adminNote       String?
  reviewedAt      DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([userId])
  @@index([status])
  @@index([periodStart, periodEnd])
}


model SessionPause {
  id             String     @id @default(cuid())
  sessionId      String
  session        Session    @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  type           String
  sequence       Int
  startedAt      DateTime
  endedAt        DateTime?
  durationMinutes Int?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@index([sessionId, type, sequence])
}

model ShiftAssignment {
  id        Int      @id @default(autoincrement())
  userId    Int
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  startsAt  DateTime
  endsAt    DateTime
  label     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, startsAt])
  @@index([userId, endsAt])
}
